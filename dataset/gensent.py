# ГЕНЕРАЦИЯ ДАТАСЕТА
# В ИТОГОВЫЙ ГИТ НЕ ИДЕТ

import pandas as pd
import numpy as np
from datetime import datetime, timedelta
import random
import os

# ------------------------------
# Настройки
# ------------------------------
NUM_USERS = 5000
NUM_TASKS = 200_000

# Полные 200 рабочих категорий (из предоставленного списка)
WORK_CATEGORIES = [
    "Работа", "Встреча", "Исследование", "Дизайн", "Кодирование", "Отладка", "Администрирование",
    "Обучение", "Поддержка", "Звонок клиенту", "Планирование", "Финансы", "Здоровье",
    "Личные дела", "Покупки", "Волонтёрство", "Юридические вопросы", "Маркетинг", "Образование", "Прочее",
    "Анализ данных", "Презентация", "Совещание", "Брифинг", "Контроль проекта", "Тестирование",
    "Рефакторинг", "Написание документации", "Чтение документации", "Написание отчёта",
    "Креативная работа", "Ведение блогов", "Соцсети", "Продвижение", "SEO", "Реклама", "Вебинар",
    "Подготовка лекции", "Консультация", "Коучинг", "Планирование задач", "Созвон с командой",
    "Составление бюджета", "Оплата счетов", "Покупка продуктов", "Готовка", "Уборка дома", "Спорт",
    "Йога", "Медитация", "Сон", "Отдых", "Путешествие", "Бронирование билетов", "Чтение",
    "Просмотр видео", "Музыка", "Игра на инструменте", "Онлайн-курсы", "Изучение языка",
    "Переписка", "Электронная почта", "Написание писем", "Планирование встреч", "Работа с клиентами",
    "Обработка заказов", "Логистика", "Склад", "Контроль качества", "Аудит", "Встреча с партнёром",
    "Подготовка договора", "Подписание договора", "Проверка документов", "Регистрация",
    "Обновление базы данных", "Загрузка файлов", "Резервное копирование", "Техническая поддержка",
    "Настройка ПО", "Установка программ", "Обновление ПО", "Разработка интерфейса", "UX-дизайн",
    "UI-дизайн", "Создание макета", "Проверка макета", "Фотография", "Видеосъёмка", "Монтаж видео",
    "Озвучка", "Пост-продакшн", "Моделирование", "3D-графика", "Иллюстрации", "Создание логотипа",
    "Брендинг", "Разработка продукта", "Исследование рынка", "Анализ конкурентов", "Стратегия",
    "KPI", "OKR", "Прогнозирование", "План продаж", "Ведение CRM", "Ведение ERP",
    "Финансовый анализ", "Отчётность", "Бухгалтерия", "Налоги", "Контроль расходов",
    "Контроль доходов", "Управление проектом", "Agile-сессия", "Scrum-встреча", "Канбан-планирование",
    "Jira-задача", "Trello-доска", "Аналитика", "SQL-запрос", "Обработка данных",
    "Визуализация данных", "Отчёт Tableau", "Power BI", "Python-скрипт", "R-анализ",
    "Машинное обучение", "NLP-задачи", "CV-задачи", "Обработка изображений", "Тестирование ПО",
    "Unit-тест", "Интеграционное тестирование", "Regression-тест", "Документирование тестов",
    "Сбор требований", "Валидация требований", "Встреча с заказчиком", "Демо", "Обратная связь",
    "Постановка задачи", "Оценка задачи", "Декомпозиция задачи", "Создание roadmap",
    "Составление sprint backlog", "Планирование релиза", "Подготовка презентации", "Обзор продукта",
    "Сравнение версий", "Миграция данных", "Очистка данных", "Обогащение данных",
    "Визуальный контроль", "Настройка серверов", "Обслуживание серверов", "Мониторинг системы",
    "Логирование", "Тестирование производительности", "Оптимизация кода",
    "Оптимизация базы данных", "Документирование процессов", "Подготовка инструкций",
    "Обучение сотрудников", "Наставничество", "Подготовка вебинара", "Создание контента",
    "Написание статьи", "Редактирование текста", "Корректура", "Проверка фактов",
    "Проверка ссылок", "Подготовка отчёта", "Анализ отчёта", "Встреча с инвестором",
    "Подготовка финансовой модели", "Pitch deck", "Сбор обратной связи", "Обсуждение стратегии",
    "Корпоративное собрание", "Тимбилдинг", "HR-задачи", "Подбор персонала", "Собеседование",
    "Адаптация сотрудника", "Разработка регламента", "Контроль выполнения задач", "Контроль KPI",
    "Проведение опроса", "Создание анкеты", "Обработка анкеты", "Отчёт по опросу",
    "Планирование мероприятий", "Организация конференции", "Организация семинара",
    "Подготовка материалов", "Доставка материалов", "Аренда помещения", "Встреча с партнёрами",
    "Подведение итогов"
]

# Полные 200 домашних категорий (из предоставленного списка)
HOME_CATEGORIES = [
    "Уборка квартиры", "Мытьё посуды", "Стирка белья", "Глажка одежды", "Смена постельного белья",
    "Пылесосить", "Протирка пыли", "Мытьё окон", "Полив растений", "Вынос мусора",
    "Переработка отходов", "Организация шкафов", "Раскладка продуктов", "Приготовление завтрака",
    "Приготовление обеда", "Приготовление ужина", "Планирование меню", "Покупка продуктов",
    "Составление списка покупок", "Поход в магазин", "Оплата коммунальных услуг", "Оплата счетов",
    "Проверка квитанций", "Организация пространства", "Ремонт техники", "Замена лампочек",
    "Мелкий ремонт мебели", "Чистка холодильника", "Чистка духовки", "Чистка микроволновки",
    "Чистка посудомоечной машины", "Чистка плитки", "Мытьё пола", "Мытьё дверей", "Чистка ковров",
    "Чистка мягкой мебели", "Организация кладовки", "Проверка сроков продуктов", "Организация документов",
    "Оплата кредитов", "Оплата штрафов", "Покупка бытовой химии", "Покупка косметики", "Поход к врачу",
    "Медицинский осмотр", "Приём лекарств", "Смена фильтров воды", "Чистка кондиционера",
    "Чистка вентиляции", "Проверка батарей", "Обслуживание котла", "Проверка пожарной сигнализации",
    "Замена батареек в детекторах", "Прогулка с питомцем", "Кормление питомца", "Визит к ветеринару",
    "Стрижка питомца", "Чистка аквариума", "Чистка клетки", "Покупка корма", "Чтение",
    "Просмотр сериалов", "Просмотр фильмов", "Просмотр новостей", "Слушание музыки", "Прогулка",
    "Поход в парк", "Велопрогулка", "Пробежка", "Зарядка", "Йога", "Медитация", "Ванна", "Душ",
    "Уход за лицом", "Уход за телом", "Уход за волосами", "Маникюр", "Педикюр", "Покупка одежды",
    "Организация гардероба", "Сортировка обуви", "Поход по магазинам", "Сборка мебели",
    "Сборка техники", "Разборка техники", "Настройка техники", "Обслуживание автомобиля",
    "Мойка автомобиля", "Замена масла", "Замена шин", "Проверка давления", "Заправка автомобиля",
    "Поездка на заправку", "Поездка в сервис", "Планирование бюджета", "Учёт расходов",
    "Учёт доходов", "Обновление финансовых таблиц", "Оплата подписок", "Проверка почты",
    "Переписка с родственниками", "Переписка с друзьями", "Видеозвонок", "Звонок другу",
    "Организация встречи с друзьями", "Покупка подарков", "Упаковка подарков", "Доставка подарков",
    "Поздравления", "Сборка подарка", "Планирование праздника", "Организация дня рождения",
    "Организация праздника", "Уборка после праздника", "Покупка праздничных товаров",
    "Поход в магазин за праздничными товарами", "Подготовка ужина для гостей", "Приготовление закусок",
    "Приготовление напитков", "Накрытие стола", "Мытьё посуды после гостей", "Чтение книги детям",
    "Купание детей", "Укладывание детей спать", "Подготовка завтрака детям", "Подготовка ланча детям",
    "Сбор детей в школу", "Проведение домашних уроков", "Проверка домашних заданий",
    "Помощь с домашними заданиями", "Организация спортивной секции", "Поездка на тренировку",
    "Организация кружков", "Творческая работа с детьми", "Игры с детьми", "Покупка игрушек",
    "Организация детской комнаты", "Стирка детской одежды", "Глажка детской одежды",
    "Мытьё детской посуды", "Чтение инструкций", "Сборка игрушек", "Чистка игрушек",
    "Организация хранения игрушек", "Поход в аптеку", "Проверка аптечки", "Закупка лекарств",
    "Подготовка лекарств детям", "Контроль приёма лекарств", "Покупка витаминов",
    "Организация тренировок", "Контроль тренировок", "Подготовка спортивного инвентаря",
    "Чистка спортивного инвентаря", "Подготовка формы", "Мытьё обуви", "Чистка спортивной одежды",
    "Планирование отдыха", "Поездка на дачу", "Садовые работы", "Полив огорода", "Прополка",
    "Сбор урожая", "Заготовка продуктов", "Консервация", "Заморозка продуктов", "Приготовление варенья",
    "Замешивание теста", "Выпечка", "Приготовление десертов", "Организация кухни",
    "Чистка кухонной техники", "Мытьё кастрюль", "Чистка сковородок", "Организация кладовки",
    "Контроль запасов продуктов", "Проверка сроков годности", "Покупка бытовой техники",
    "Проверка техники на работоспособность", "Настройка бытовой техники", "Установка бытовой техники",
    "Разборка бытовой техники", "Чистка бытовой техники", "Проверка электричества",
    "Замена предохранителей", "Проверка розеток", "Проверка проводки", "Чистка вентиляции",
    "Проверка фильтров", "Замена фильтров", "Чистка кондиционера", "Проверка отопления",
    "Проверка труб", "Чистка труб", "Мелкий сантехнический ремонт", "Установка полок",
    "Ремонт дверей", "Ремонт окон", "Контроль за ремонтом"
]

# Объединяем все категории и удаляем дубликаты (теперь 392 уникальных)
ALL_CATEGORIES = list(set(WORK_CATEGORIES + HOME_CATEGORIES))


# ------------------------------
# Функции генерации
# ------------------------------
def random_datetime(start, end):
    delta = end - start
    return start + timedelta(seconds=random.randint(0, int(delta.total_seconds())))


def generate_task(user_id, task_num):
    task_id = f"{user_id}_{task_num:04d}"  # Уникальный формат с ведущими нулями
    category = random.choice(ALL_CATEGORIES)  # Равномерное распределение категорий

    # Planned_duration: экспоненциальное, но ограничим max=8 часами для реализма
    planned_duration = round(np.clip(np.random.exponential(scale=2.0) + 0.5, 0.5, 8.0), 1)

    # Actual_duration: на основе planned, с вариацией (70-150%), но не меньше 0.1
    actual_duration = round(np.clip(planned_duration * np.random.uniform(0.7, 1.5), 0.1, 10.0), 1)

    # Deadline: от -7 дней (просроченные) до +30 дней для разнообразия
    now = datetime.now()
    deadline = random_datetime(now - timedelta(days=7), now + timedelta(days=30))

    # Priority: сбалансированное распределение
    priority = np.random.choice([1, 2, 3, 4, 5], p=[0.1, 0.2, 0.3, 0.25, 0.15])

    # Time_of_day: как str в формате 'HH:MM'
    time_of_day = deadline.strftime('%H:%M')

    # Day_of_week: 1-7
    day_of_week = deadline.isoweekday()

    # Fatigue и focus: зависят от времени дня + шум
    # Утро (6-12): низкая fatigue, высокая focus
    # День (12-18): средняя
    # Вечер/ночь: высокая fatigue, низкая focus
    hour = deadline.hour
    if 6 <= hour < 12:
        fatigue_base = 2.0
        focus_base = 8.0
    elif 12 <= hour < 18:
        fatigue_base = 4.0
        focus_base = 7.0
    else:
        fatigue_base = 6.0
        focus_base = 5.0

    fatigue_level = round(np.clip(np.random.normal(loc=fatigue_base, scale=1.5), 0, 10), 1)
    focus_level = round(np.clip(np.random.normal(loc=focus_base, scale=1.5), 0, 10), 1)

    # Productivity: улучшенная формула с шумом для реализма
    # Базовая: (planned / actual) * (focus/10) * (1 - fatigue/10)
    # + Коррекция на priority (выше приоритет — выше productivity)
    # + Коррекция на days_to_deadline (ближе дедлайн — ниже, если >0; просрочка — сильно ниже)
    days_to_deadline = (deadline - now).days
    deadline_factor = 1.0 if days_to_deadline > 7 else max(0.5, 1 - abs(days_to_deadline) / 10)
    if days_to_deadline < 0:
        deadline_factor *= 0.7  # Штраф за просрочку

    base_prod = (planned_duration / actual_duration) * (focus_level / 10) * (1 - fatigue_level / 10)
    productivity = round(
        np.clip(base_prod * (1 + priority * 0.05) * deadline_factor + np.random.uniform(-0.1, 0.1), 0.01, 1.0), 2)

    return {
        "user_id": user_id,
        "task_id": task_id,
        "planned_duration": planned_duration,
        "actual_duration": actual_duration,
        "deadline": deadline.strftime('%Y-%m-%d %H:%M'),  # str формат как в примерах
        "day_of_week": day_of_week,
        "time_of_day": time_of_day,
        "category": category,
        "fatigue_level": fatigue_level,
        "focus_level": focus_level,
        "priority": priority,
        "productivity": productivity
    }


# ------------------------------
# Генерация задач
# ------------------------------
data = []
user_ids = [f"U{str(i).zfill(4)}" for i in range(1, NUM_USERS + 1)]  # U0001 - U5000

# Распределяем задачи равномерно по пользователям
tasks_per_user = NUM_TASKS // NUM_USERS
extra_tasks = NUM_TASKS % NUM_USERS

task_counters = {user: 0 for user in user_ids}  # Счетчик задач на пользователя для уникальности

for i, user in enumerate(user_ids):
    num_tasks = tasks_per_user + (1 if i < extra_tasks else 0)
    for _ in range(num_tasks):
        task_counters[user] += 1
        data.append(generate_task(user, task_counters[user]))

# Проверяем отсутствие пропусков и уникальность
df = pd.DataFrame(data)
assert df.isnull().sum().sum() == 0, "Есть пропуски в данных!"
assert len(df['task_id'].unique()) == NUM_TASKS, "Дубликаты task_id!"

# ------------------------------
# Сохраняем CSV
# ------------------------------
df.to_csv("models/dataset.csv", index=False)
print("Готов CSV: dataset.csv")
print("Количество строк:", len(df))
print("Количество уникальных пользователей:", len(df['user_id'].unique()))
print("Количество уникальных категорий:", len(df['category'].unique()))
print("Распределение продуктивности:", df['productivity'].describe())